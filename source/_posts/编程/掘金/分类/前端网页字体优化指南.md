
---
title: '前端网页字体优化指南'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/802528252a4845028c6df92cbedc6627~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Wed, 14 Jul 2021 18:18:54 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/802528252a4845028c6df92cbedc6627~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>日常开发网页经常会使用一些特殊字体，比如思源黑体、苹方字体等，因为这些字体在一般的宿主环境中是不存在的，需要通过 css 的 <code>@font-face</code> 定义，并从服务器中加载对应的字体文件，而字体文件一般都是比较大的，甚至有时候一个字体比其他所有的资源（js、css、图片）加起来还要大，对网页的加载性能起到非常关键的影响，因此有必要对字体进行一些优化。 本文主要从字体格式、按需提取、统一渲染三个方面来谈谈优化字体的常用技巧。</p>
<h2 data-id="heading-0">转换字体格式</h2>
<p>现在是 1202 年了，各主流设备基本都支持 woff2 字体格式，因此网站中没有必要再引入多种不同格式的字体了。一般地，建议只引入 woff2  就好了，既可以保持代码的简洁性，又可以减少上传到你服务器的文件，何乐而不为？</p>
<p>可是很多时候美术同学只提供其他格式的字体文件给我们，比如 TTF 或 OTF，那如何将其转换成 woff2 呢？</p>
<ul>
<li>
<h4 data-id="heading-1">TTF 字体转 WOFF2</h4>
</li>
</ul>
<p>TTF 字体，是苹果和 windows 都支持的一种字体，因此是美术同学最喜欢用的。TTF 转换 WOFF2 是比较简单的，可以选择线上转换，推荐的网站有以下两个</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Feverythingfonts.com%2Fttf-to-woff2" target="_blank" rel="nofollow noopener noreferrer" title="https://everythingfonts.com/ttf-to-woff2" ref="nofollow noopener noreferrer">ttf-to-woff2</a></li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.fontsquirrel.com%2Ftools%2Fwebfont-generator" target="_blank" rel="nofollow noopener noreferrer" title="https://www.fontsquirrel.com/tools/webfont-generator" ref="nofollow noopener noreferrer">webfont-generator</a></li>
</ul>
<p>但是个人觉得线上转换等待上传的时间比较久，而且有时候生成的文件是空白的，因此更加倾向于使用 node 库 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fttf2woff2" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/ttf2woff2" ref="nofollow noopener noreferrer">ttf2woff2</a> 转换。该库的周下载量达到 10w+ 的，可见好多人都会有将 tff 转换成 woff2 的需求。
使用方法也很简单：</p>
<pre><code class="copyable">cat font.ttf | ttf2woff2 > font.woff2
<span class="copy-code-btn">复制代码</span></code></pre>
<p>因为使用 了 cat 命令来提取 ttf 的内容，如果你使用的是 windows ，需要使用 git bash  或 wsl 来运行。</p>
<ul>
<li>
<h4 data-id="heading-2">OTF 转 WOFF2</h4>
</li>
</ul>
<p>除了 TTF ，美术同学还经常提供 OTF 给我们，这是微软和 Adobe 共同研发的字体，因此在 windows 平台还是比较流行的。那如何将其转换成 WOFF2 呢？目前我还没有发现哪个线上网站或 node 库能一步到位转换的，在 google 上搜索好几个线上转换的网站，要么转换完成后无法下载 ，要么转换下载后是个空文件，反正就是不靠谱的东西。</p>
<p>经过一番折腾后，找到了一个不错的 python 库 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fawesometoolbox%2Fotf2ttf" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/awesometoolbox/otf2ttf" ref="nofollow noopener noreferrer">otf2ttf</a>，能够稳定的将 otf 转 ttf。
使用方法也比较简单，首先安装  python，然后通过 pip 安装  otf2ttf 就可以使用了（pip 类似于 npm，是 python 的包管理器），不过官方的文档中示例代码应该是有一点小笔误：</p>
<pre><code class="copyable">otf2ttf MyFont.ttf
<span class="copy-code-btn">复制代码</span></code></pre>
<p>里面的 MyFont.ttf 应该是 MyFont.otf 才对，因为这个 input 应该是 OTF 类型而不是 TTF 。</p>
<p>使用 python otf2ttf 生成 ttf 文件 后，就可以使用上面提到的将 ttf 转换成 woff2 的方法获取到 woff2 了。</p>
<blockquote>
<p>关于字体转换的这里再啰嗦一下：有时候美术同学还会提供 ttc 文件给我们，这不是单个字体，而是将多种字体打包在一起了，需要从中提取出 ttf 后才能使用，可以尝试使用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fttc2ttf" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/ttc2ttf" ref="nofollow noopener noreferrer">TTC2TTF</a>。</p>
</blockquote>
<h2 data-id="heading-3">按需压缩字体</h2>
<p>一般的，尽管将字体转换成 woff2 格式，最小依然也有好几百 K ，而更多情况下会有 1-4M 左右。有时候，我们只有少数的文字需要用到特殊字体，比如说只有 <code>0-9</code>  这 10 个数字用到某种特殊字体，如果把整个字体文件引入就没有必要了，比切10个图片还要大。好在有一些技术能够将 <code>0-9</code> 这10个数字对应的字体子集提取出来。我平时会使用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Faui%2Ffont-spider" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/aui/font-spider" ref="nofollow noopener noreferrer">font-spider 字蜘</a> 来提取。</p>
<p>首先，全局安装  font-spider:</p>
<pre><code class="copyable">npm install font-spider -g
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后，新建一个 html 文件，比如文件名为 <code>index.html</code> ，里面用一个元素包含所有的你想要提取的文字，比如 0-9，并为这个元素定义上你想要的特殊字体：</p>
<pre><code class="hljs language-html copyable" lang="html"> <span class="hljs-tag"><<span class="hljs-name">h1</span>></span>0123456789<span class="hljs-tag"></<span class="hljs-name">h1</span>></span>


<span class="hljs-tag"><<span class="hljs-name">style</span>></span><span class="css">
<span class="hljs-keyword">@font-face</span> &#123;
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'sourceHan'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'./SourceHanSansCN-Regular.ttf'</span>);
  <span class="hljs-attribute">font-weight</span>: normal;
  <span class="hljs-attribute">font-style</span>: normal;
&#125;


<span class="hljs-selector-tag">h1</span> &#123;
    <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'sourceHan'</span>;
&#125;
</span><span class="hljs-tag"></<span class="hljs-name">style</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>最后，在这个 html 文件所在的目录执行以下命令：</p>
<pre><code class="copyable">font-spider index.html
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这时候，原来的 <code>SourceHanSansCN-Regular.ttf</code>  就会被移动到 <code>.font-spider/</code> 目录下，而原来位置的字体会被替换成只提取了 <code>0-9</code> 的字体文件。这个体积相差了好几个数量级的：</p>
<p>完整的字体文件大小是 10M ：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/802528252a4845028c6df92cbedc6627~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>只提取 <code>0-9</code> 10 个数字的字体文件只有 7K：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3a9ada5912c4828915baf3e6d17997f~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>所以，如果你的网站内容是静态不变的，则建议使用 font-spider 将你所要用到的文字提取出来，这将会大大的减少字体文件的体积。</p>
<h2 data-id="heading-4">统一渲染时机</h2>
<p>将字体转换成 WOFF2 及静态内容网站使用 font-spider 进行按需压缩，可以很好的控制字体的大小。（PS：WOFF2 字体没有必要再开启 GZIP，因为这个字体文本本身就是压缩过的）。</p>
<p>最后，我们再来看看网络速度对字体内容的影响，假如你的网页全部内容都使用某种字体，CSS 定义如下：</p>
<pre><code class="copyable">@font-face &#123;
  font-family: myfont;
  src: url('./myfont.woff2') format('woff2');
&#125;


body &#123;
  font-family: myfont;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>假如这个 myfont.woff2 文件大小为 4M，而网络下载速度只有 1M/s  ，则加载这个字体需要 4 秒钟。这4秒期间由于还没有加载完成远程字体，浏览器会使用什么字体渲染呢？事实上，不同的浏览器表现会不一样的，以下是一些常见的桌面浏览器的表现：</p>
<ul>
<li>
<p>IE：它会直接使用备用字体渲染，最后等webfont字体加载完毕后重新渲染。</p>
</li>
<li>
<p>Safari：它会一直等待webfont字体加载完毕，并且期间不会渲染字体。</p>
</li>
<li>
<p>Chrome / Firefox：它们会等待webfont字体加载，如果在3秒之内没有加载完毕，则使用备用字体渲染。最后webfont加载完毕，使用并重新渲染。</p>
</li>
</ul>
<p>我们需要想办法统一这些行为，比较理想的行为是：先使用系统默认字体，等到远程字体加载完成了再替换成特殊字体。借助于 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ftypekit%2Fwebfontloader" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/typekit/webfontloader" ref="nofollow noopener noreferrer">WebFontLoader</a> 可以很容易的实现这一效果。下面来看一下如何使用:</p>
<ol>
<li>在 css 中通过 @font-face 定义一个字体：</li>
</ol>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-keyword">@font-face</span> &#123;
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'myfont'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'./myfont.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<blockquote>
<p>注意，CSS 中只需要定义字体就行，而不要使用使用这个字休。</p>
</blockquote>
<ol start="2">
<li>然后 引入 webfontloader  (也可以通过 npm 安装)，将你在 css 中定义的字体名称添加到 <code>custom.families</code> 列表中，并在 active 回调中将该字体添加到对应的元素上，代码如下：</li>
</ol>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
WebFont.load(&#123;
  <span class="hljs-attr">custom</span>: &#123;
    <span class="hljs-attr">families</span>: [<span class="hljs-string">'myfont'</span>],
  &#125;,
  <span class="hljs-attr">classes</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-function"><span class="hljs-title">active</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">document</span>.body.style.fontFamily = <span class="hljs-string">'myfont'</span>;
  &#125;,
&#125;);
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样浏览器一开始就会使用默认字体渲染内容，等字体加载完成后再使用特殊字体重新渲染。</p>
<h2 data-id="heading-5">小结</h2>
<p>关于字体优化技巧就先写到这里啦，有问题的欢迎留言交流哈。</p></div>  
</div>
            